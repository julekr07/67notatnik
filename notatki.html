<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Notatnik</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #000; color: #fff; }
    .bg-secondary { background-color: #111 !important; }
    .border-warning { border-color: #ff9800 !important; }
    .text-warning { color: #ff9800 !important; }
    .btn-warning { background-color: #ff9800 !important; border-color: #ff9800 !important; color: #000 !important; }
    .btn-danger { background-color: #dc3545 !important; border-color: #dc3545 !important; color: #fff !important; }
    .form-control { background-color: #000 !important; border-color: #ff9800 !important; color: #fff !important; }
    .list-group-item { background-color: #000; border-color: #ff9800; color: #fff; }
  </style>
</head>
<body class="container-fluid py-5">
  <div class="row">
    <!-- LEWA KOLUMNA -->
    <div class="col-12 col-md-3">
      <div class="p-3 bg-secondary border border-warning rounded">
        <h3 class="mb-3">Linki</h3>
        <ul class="list-unstyled">
          <li class="mb-2"><a href="login.html" class="text-warning text-decoration-none" id="logoutLink">Wyloguj siƒô</a></li>
          <li class="mb-2"><a href="tablica.html" class="text-warning text-decoration-none">Tablica</a></li>
          <li><a href="notatki.html" class="text-warning text-decoration-none">Notatki</a></li>
        </ul>
      </div>
    </div>

    <!-- PRAWA KOLUMNA -->
    <div class="col-12 col-md-9">
      <h1 class="text-warning mb-4">üìù M√≥j Notatnik</h1>

      <div id="status" class="mb-3"></div>

      <!-- Formularz dodawania notatki -->
      <div class="mb-3">
        <input id="noteTitle" class="form-control border-warning mb-2" placeholder="Temat notatki (opcjonalny)">
        <textarea id="noteInput" class="form-control border-warning" rows="3" placeholder="Tre≈õƒá notatki..."></textarea>
      </div>
      <button id="addNoteBtn" class="btn btn-warning">Dodaj notatkƒô</button>

      <!-- Lista notatek -->
      <h3 class="text-warning mt-5">Twoje notatki:</h3>
      <ul id="notesList" class="list-group mt-3"></ul>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost/67notatnik/api.php";
    const statusBox = document.getElementById("status");

    const token = localStorage.getItem("token");
    const userId = localStorage.getItem("userid");

    let notes = [];

    const notesList = document.getElementById("notesList");
    const noteInput = document.getElementById("noteInput");
    const noteTitle = document.getElementById("noteTitle");
    const addNoteBtn = document.getElementById("addNoteBtn");

    function parseNoteContent(content) {
      try {
        const obj = JSON.parse(content);
        return { title: obj.title || "", text: obj.text || "" };
      } catch (_) {
        return { title: "", text: content || "" };
      }
    }

    function displayTitleOrPreview(noteObj) {
      if (noteObj.title.trim()) return noteObj.title;
      return noteObj.text.split(/\s+/).slice(0, 3).join(" ");
    }

    function renderNotes() {
      notesList.innerHTML = "";
      notes.forEach((note, index) => {
        const { title, text } = parseNoteContent(note.content);

        const li = document.createElement("li");
        li.className = "list-group-item border-warning d-flex justify-content-between align-items-center";

        const textSpan = document.createElement("span");
        textSpan.textContent = displayTitleOrPreview({ title, text });

        const btnGroup = document.createElement("div");

        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-sm btn-warning me-2";
        editBtn.textContent = "‚úèÔ∏è Edytuj";
        editBtn.onclick = () => {
          noteTitle.value = title;
          noteInput.value = text;
          notes.splice(index, 1);
          renderNotes();
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn btn-sm btn-danger";
        deleteBtn.textContent = "üóëÔ∏è Usu≈Ñ";
        deleteBtn.onclick = () => {
          notes.splice(index, 1);
          renderNotes();
        };

        btnGroup.appendChild(editBtn);
        btnGroup.appendChild(deleteBtn);
        li.appendChild(textSpan);
        li.appendChild(btnGroup);
        notesList.appendChild(li);
      });
    }

    async function loadNotes() {
      if (!token) {
        statusBox.innerHTML = '<div class="alert alert-danger">Brak tokena. Zaloguj siƒô ponownie.</div>';
        return;
      }
      try {
        const res = await fetch(`${API_BASE}?endpoint=notes`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ read: true })
        });
        const data = await res.json();
        notes = Array.isArray(data) ? data : [];
        renderNotes();
      } catch (err) {
        statusBox.innerHTML = `<div class="alert alert-danger">B≈ÇƒÖd sieci/API: ${err}</div>`;
      }
    }

    async function addNote() {
      const title = noteTitle.value.trim();
      const text = noteInput.value.trim();
      if (!text) return;

      const payload = { title, text };
      try {
        const res = await fetch(`${API_BASE}?endpoint=notes`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ content: JSON.stringify(payload) })
        });
        const data = await res.json();
        notes.unshift({ id: data.id, userId: Number(userId || 0), content: JSON.stringify(payload) });
        noteTitle.value = "";
        noteInput.value = "";
        renderNotes();
      } catch (err) {
        statusBox.innerHTML = `<div class="alert alert-danger">B≈ÇƒÖd dodawania notatki: ${err}</div>`;
      }
    }

    addNoteBtn.addEventListener("click", addNote);

    document.getElementById("logoutLink").addEventListener("click", () => {
      localStorage.removeItem("token");
      localStorage.removeItem("userid");
    });

    loadNotes();
  </script>
</body>
</html>
